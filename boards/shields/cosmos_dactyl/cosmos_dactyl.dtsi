/*
 * Copyright (c) 2020 Pete Johanson, Ryan Cross
 *
 * SPDX-License-Identifier: MIT
 */

#include <dt-bindings/zmk/matrix_transform.h>

#include <physical_layouts.dtsi>

#include <input/processors.dtsi>

/ {
    cosmos_dactyl_layout: cosmos_dactyl_layout {
        compatible = "zmk,physical-layout";
        display-name = "Cosmos Dactyl";

        kscan = <&kscan0>;
        transform = <&default_transform>;

        keys  //                     w   h    x    y     rot    rx    ry
            = <&key_physical_attrs 125 100    0  128       0     0     0>
            , <&key_physical_attrs 100 100  125  126       0     0     0>
            , <&key_physical_attrs 100 100  232   50       0     0     0>
            , <&key_physical_attrs 100 100  335    0     100   385    50>
            , <&key_physical_attrs 100 100  426   62     100   476   112>
            , <&key_physical_attrs 100 100  517   63     100   567   113>
            , <&key_physical_attrs 100 100 1414   63  (-100)  1464   113>
            , <&key_physical_attrs 100 100 1504   62  (-100)  1554   112>
            , <&key_physical_attrs 100 100 1595    0  (-100)  1645    50>
            , <&key_physical_attrs 100 100 1699   50       0     0     0>
            , <&key_physical_attrs 100 100 1806  126       0     0     0>
            , <&key_physical_attrs 125 100 1931  128       0     0     0>
            , <&key_physical_attrs 125 100    9  233       0     0     0>
            , <&key_physical_attrs 100 100  138  231       0     0     0>
            , <&key_physical_attrs 100 100  249  155       0     0     0>
            , <&key_physical_attrs 100 100  356  105     100   406   155>
            , <&key_physical_attrs 100 100  450  168     100   500   218>
            , <&key_physical_attrs 100 100  543  169     100   593   219>
            , <&key_physical_attrs 100 100 1387  169  (-100)  1437   219>
            , <&key_physical_attrs 100 100 1481  168  (-100)  1531   218>
            , <&key_physical_attrs 100 100 1575  105  (-100)  1625   155>
            , <&key_physical_attrs 100 100 1682  155       0     0     0>
            , <&key_physical_attrs 100 100 1793  231       0     0     0>
            , <&key_physical_attrs 125 100 1922  233       0     0     0>
            , <&key_physical_attrs 125 100   12  347       0     0     0>
            , <&key_physical_attrs 100 100  142  345       0     0     0>
            , <&key_physical_attrs 100 100  254  269       0     0     0>
            , <&key_physical_attrs 100 100  363  219     100   413   269>
            , <&key_physical_attrs 100 100  458  281     100   508   331>
            , <&key_physical_attrs 100 100  552  282     100   602   332>
            , <&key_physical_attrs 100 100 1378  282  (-100)  1428   332>
            , <&key_physical_attrs 100 100 1473  281  (-100)  1523   331>
            , <&key_physical_attrs 100 100 1568  219  (-100)  1618   269>
            , <&key_physical_attrs 100 100 1676  269       0     0     0>
            , <&key_physical_attrs 100 100 1788  345       0     0     0>
            , <&key_physical_attrs 125 100 1918  347       0     0     0>
            , <&key_physical_attrs 125 100    9  461       0     0     0>
            , <&key_physical_attrs 100 100  138  459       0     0     0>
            , <&key_physical_attrs 100 100  249  383       0     0     0>
            , <&key_physical_attrs 100 100  356  333     100   406   383>
            , <&key_physical_attrs 100 100  450  395     100   500   445>
            , <&key_physical_attrs 100 100  543  396     100   593   446>
            , <&key_physical_attrs 100 100 1387  396  (-100)  1437   446>
            , <&key_physical_attrs 100 100 1481  395  (-100)  1531   445>
            , <&key_physical_attrs 100 100 1575  333  (-100)  1625   383>
            , <&key_physical_attrs 100 100 1682  383       0     0     0>
            , <&key_physical_attrs 100 100 1793  459       0     0     0>
            , <&key_physical_attrs 125 100 1922  461       0     0     0>
            , <&key_physical_attrs 125 100    0  568       0     0     0>
            , <&key_physical_attrs 100 100  125  566       0     0     0>
            , <&key_physical_attrs 100 100  232  489       0     0     0>
            , <&key_physical_attrs 100 100  335  440     100   385   490>
            , <&key_physical_attrs 100 100 1595  440  (-100)  1645   490>
            , <&key_physical_attrs 100 100 1699  489       0     0     0>
            , <&key_physical_attrs 100 100 1806  566       0     0     0>
            , <&key_physical_attrs 125 100 1931  568       0     0     0>
            , <&key_physical_attrs 150 100  593  543   11000   643   593>
            , <&key_physical_attrs 100 100  686  600    4000   736   650>
            , <&key_physical_attrs 100 100  718  692    5200   768   742>
            , <&key_physical_attrs 150 100  480  553   11000   530   603>
            , <&key_physical_attrs 100 100  569  684    4800   619   734>
            , <&key_physical_attrs 100 100  615  759    5400   665   809>
            , <&key_physical_attrs 150 100 1337  543 (-11000)  1387   593>
            , <&key_physical_attrs 100 100 1245  600 (-4000)  1295   650>
            , <&key_physical_attrs 100 100 1213  692 (-5200)  1263   742>
            , <&key_physical_attrs 150 100 1451  553 (-11000)  1501   603>
            , <&key_physical_attrs 100 100 1362  684 (-4800)  1412   734>
            , <&key_physical_attrs 100 100 1316  759 (-5400)  1366   809>
            ;
    };
};

/ {
    chosen {
        zephyr,display = &oled;
        zmk,kscan = &kscan0;
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <12>;
        rows = <6>;
// | SW6  | SW5  | SW4  | SW3  | SW2  | SW1  |                 | SW1  | SW2  | SW3  | SW4  | SW5  | SW6  |
// | SW12 | SW11 | SW10 | SW9  | SW8  | SW7  |                 | SW7  | SW8  | SW9  | SW10 | SW11 | SW12 |
// | SW18 | SW17 | SW16 | SW15 | SW14 | SW13 |                 | SW13 | SW14 | SW15 | SW16 | SW17 | SW18 |
// | SW24 | SW23 | SW22 | SW21 | SW20 | SW19 | SW25 |   | SW25 | SW19 | SW20 | SW21 | SW22 | SW23 | SW24 |
//               | SW30 | SW29 | SW28 | SW27 | SW26 |   | SW26 | SW27 | SW28 | SW29 | SW30 |
        map = <
RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4) RC(0,5)                 RC(0,6) RC(0,7) RC(0,8) RC(0,9) RC(0,10) RC(0,11)
RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4) RC(1,5)                 RC(1,6) RC(1,7) RC(1,8) RC(1,9) RC(1,10) RC(1,11)
RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4) RC(2,5)                 RC(2,6) RC(2,7) RC(2,8) RC(2,9) RC(2,10) RC(2,11)
RC(3,0) RC(3,1) RC(3,2) RC(3,3) RC(3,4) RC(3,5)                 RC(3,6) RC(3,7) RC(3,8) RC(3,9) RC(3,10) RC(3,11)
RC(4,0) RC(4,1) RC(4,2) RC(4,3)                                                 RC(4,8) RC(4,9) RC(4,10) RC(4,11)
RC(5,0) RC(5,1) RC(5,2) RC(5,3) RC(5,4) RC(5,5)                 RC(6,6) RC(6,7) RC(6,8) RC(6,9) RC(6,10) RC(6,11)
        >;
    };
    
    kscan0: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        wakeup-source;

        diode-direction = "col2row";
        row-gpios
            = <&pro_micro 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&pro_micro 8 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&pro_micro 9 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&pro_micro 20 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&pro_micro 21 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&pro_micro 6 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;
    };
};

&pro_micro_i2c {
    status = "okay";

    oled: ssd1306@3c {
        compatible = "solomon,ssd1306fb";
        reg = <0x3c>;
        width = <128>;
        height = <32>;
        segment-offset = <0>;
        page-offset = <0>;
        display-offset = <0>;
        multiplex-ratio = <31>;
        segment-remap;
        com-invdir;
        com-sequential;
        inversion-on;
        prechargep = <0x22>;
    };

    // Cribbed from https://github.com/Cyboard-DigitalTailor/zmk-keyboards/tree/main

    //right hand trackball
    split_inputs {
        #address-cells = <1>;
        #size-cells = <0>;

        trackball_listener_split: trackball_listener_split@0 {
            compatible = "zmk,input-split";
            reg = <0>;
        };
    };

    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        status = "disabled";
        device = <&trackball_peripheral_split>;
    };

    //left hand trackball
    scrollball_listener: scrollball_listener {
        compatible = "zmk,input-listener";
        status = "disabled";
        input-processors =  <&zip_xy_to_scroll_mapper>;
    };
};